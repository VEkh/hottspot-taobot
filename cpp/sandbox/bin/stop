#!/bin/bash
# shellcheck disable=2009

app_dir=$(realpath "$(dirname "$0")/../../")
fmt_bold="\033[1m"
fmt_cyan="\033[36m"
fmt_green="\033[32m"
fmt_red="\033[31m"
fmt_reset="\033[0m"
project=$(dirname "$0" | xargs basename)

# shellcheck disable=1091
source "$app_dir/bin/utils" # to_lower, to_upper

if [[ $project = "bin" ]]; then
  cmd=$(basename "$0")

  echo -e "${fmt_bold}${fmt_red}Please run in the context of" \
  "a project (e.g. ./bin/<project>/$cmd)${fmt_reset}"

  exit 1;
fi

shopt -s extglob

echo -e "${fmt_bold}"

case $1 in
  +([[:alpha:]_[:alpha:]]))
    symbol="$(to_upper "$1")"
    state=$(ps aux | grep "[t]ao_bot" | grep "$project" | grep -i "$(to_lower "$symbol")")

    if [[ -z $state ]]
    then
      echo -e "${fmt_green}âœ… TaoBot is not running for $symbol"
    else
      echo -e "${fmt_cyan}ðŸ›‘ Stopping TaoBot for $symbol${fmt_reset}"

      ps aux | grep "[t]ao_bot" | grep "$project"  | grep -i "$(to_lower "$symbol")" |
      awk '{print $2}' | xargs kill
    fi

    ;;

  *)
    state=$(ps aux | grep "[t]ao_bot" | grep "$project"  )

    if [[ -z $state ]]
    then
      echo -e "${fmt_green}âœ… No TaoBot instances are running${fmt_reset}"
    else
      echo -e "${fmt_cyan}ðŸ›‘ Stopping all TaoBot instances${fmt_reset}"

      ps aux | grep "[t]ao_bot" | grep "$project"  | awk '{print $2}' |
      xargs kill
    fi
    ;;
esac
echo

printf "%b" "$fmt_reset"
