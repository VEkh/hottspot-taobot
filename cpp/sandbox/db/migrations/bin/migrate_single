#!/bin/bash

set -e

app_dir=$(realpath "$(dirname "$0")/../")

# shellcheck disable=1090
source "${app_dir}/bin/utils" # ASCII, ascii_print

function migrate_single_up() {
  db_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../../")

  # build_db_url, migration_filename_to_version, on_build_db_url_error
  # shellcheck disable=1090
  source "${db_dir}/utils"

  trap 'on_build_db_url_error' ERR
  db_url="$(build_db_url)"
  trap - ERR

  version=$(migration_filename_to_version "${1}")

  ascii_print "ðŸ”¼ Migrating ${ASCII["yellow"]}${version} ${ASCII["cyan"]}up" "cyan"

  up_cmd="psql ${db_url} < ${1}"

  sh -c "${up_cmd}"

  persist_cmd=$(
    echo -e "psql ${db_url} -v VERSION=\"${version}\"" \
    "< ${db_dir}/scripts/write_migration_version.sql"
  )

  sh -c "${persist_cmd}"

  ascii_print "ðŸŽ‰ Successfully migrated ${ASCII["yellow"]}${version} ${ASCII["green"]}up" "green"
}
