#!/bin/bash

set -e

fmt_bold="\033[1m"
fmt_cyan="\033[36m"
fmt_green="\033[32m"
fmt_reset="\033[0m"
fmt_yellow="\033[33m"

function migrate_single_up() {
  db_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../../")

  # build_db_url, migration_filename_to_version, on_build_db_url_error
  # shellcheck disable=1090
  source "${db_dir}/utils"

  trap 'on_build_db_url_error' ERR
  db_url="$(build_db_url)"
  trap - ERR

  version=$(migration_filename_to_version "${1}")

  echo -e "${fmt_bold}${fmt_cyan}ðŸ”¼ Migrating"\
          "${fmt_yellow}${version} ${fmt_cyan}up${fmt_reset}"

  up_cmd="psql ${db_url} < ${1}"

  sh -c "${up_cmd}"

  persist_cmd=$(
    echo -e "psql ${db_url} -v VERSION=\"${version}\"" \
    "< ${db_dir}/scripts/write_migration_version.sql"
  )

  sh -c "${persist_cmd}"

  echo -e "${fmt_bold}${fmt_green}ðŸŽ‰ Successfully migrated" \
          "${fmt_yellow}${version} ${fmt_green}up${fmt_reset}"
}
