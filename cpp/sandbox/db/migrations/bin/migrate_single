#!/bin/bash

set -e

app_dir=$(realpath "$(dirname "$0")/../")

# shellcheck disable=1090
source "${app_dir}/bin/utils" # ASCII, ascii_print

function migrate_single() {
  db_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../../")

  # build_db_url, migration_filename_to_version, on_build_db_url_error
  # shellcheck disable=1090
  source "${db_dir}/utils"

  action="${1}"
  [[ "${action}" = "up" ]] && action_emoji="ðŸ”¼" || action_emoji="ðŸ”½"
  filename="${2}"

  trap 'on_build_db_url_error' ERR
  db_url="$(build_db_url)"
  trap - ERR

  version=$(migration_filename_to_version "${filename}")

  ascii_print "${action_emoji} Migrating ${ASCII["yellow"]}${version} ${ASCII["cyan"]}${action}" "cyan"

  cmd="psql ${db_url} < ${filename}"
  [[ "${action}" = "up" ]] && persist_action="write" || persist_action="delete"

  sh -c "${cmd}"

  persist_cmd=$(
    echo -e "psql ${db_url} -v VERSION=\"${version}\"" \
    "< ${db_dir}/scripts/${persist_action}_migration_version.sql"
  )

  sh -c "${persist_cmd}"

  ascii_print "ðŸŽ‰ Successfully migrated ${ASCII["yellow"]}${version} ${ASCII["green"]}${action}" "green"
}
