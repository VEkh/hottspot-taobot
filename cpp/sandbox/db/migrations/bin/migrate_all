#!/bin/bash

fmt_bold="\033[1m"
fmt_green="\033[32m"
fmt_reset="\033[0m"
fmt_yellow="\033[33m"

function migrate_all_up() {
  db_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../../")
  scripts_dir="${db_dir}/scripts"

  # build_db_url, migration_filename_to_version, on_build_db_url_error
  # shellcheck disable=1090
  source "${db_dir}/utils"

  # shellcheck disable=1090
  source "${db_dir}/migrations/bin/migrate_single" # migrate_single_up

  trap 'on_build_db_url_error' ERR
  db_url="$(build_db_url)"
  trap - ERR

  echo -e "${fmt_bold}${fmt_yellow}ðŸ’¿ Running up migrations${fmt_reset}"

  db_cmd="psql ${db_url} -t < ${scripts_dir}/print_schema_migration_versions.sql"
  db_versions=($(sh -c "${db_cmd}"))

  migration_files=($(find "${migrations_dir}/up" -name "[0-9]*.sql"))

  for filename in "${migration_files[@]}"; do
    version=$(migration_filename_to_version "${filename}")

    # shellcheck disable=2076
    [[ ! " ${db_versions[*]} " =~ " ${version} " ]] && migrate_single_up "${filename}"
  done

  echo -e "${fmt_bold}${fmt_green}ðŸŽ‰ Successfully migrated" \
          "${fmt_yellow}all migrations ${fmt_green}up${fmt_reset}"
}
