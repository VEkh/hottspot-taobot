#!/bin/bash


app_dir=$(realpath "$(dirname "$0")/../")

# shellcheck disable=1090
source "${app_dir}/bin/utils" # ASCII, ascii_print

function migrate_all_up() {
  db_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../../")
  scripts_dir="${db_dir}/scripts"

  # build_db_url, migration_filename_to_version, on_build_db_url_error
  # shellcheck disable=1090
  source "${db_dir}/utils"

  # shellcheck disable=1090
  source "${db_dir}/migrations/bin/migrate_single" # migrate_single

  trap 'on_build_db_url_error' ERR
  db_url="$(build_db_url)"
  trap - ERR

  ascii_print "ðŸ’¿ Running up migrations" "yellow"

  db_cmd="psql ${db_url} -t < ${scripts_dir}/print_schema_migration_versions.sql"
  db_versions=($(sh -c "${db_cmd}"))

  migration_files=($(find "${migrations_dir}/up" -name "[0-9]*.sql"))

  for filename in "${migration_files[@]}"; do
    version=$(migration_filename_to_version "${filename}")

    # shellcheck disable=2076
    if [[ ! " ${db_versions[*]} " =~ " ${version} " ]]; then
      migrate_single "up" "${filename}"
    fi
  done

  success_msg=$(
    echo -e "ðŸŽ‰ Successfully migrated" \
            "${ASCII["yellow"]}all migrations ${ASCII["green"]}up\n"
  )

  ascii_print "${success_msg}" "green"
}
