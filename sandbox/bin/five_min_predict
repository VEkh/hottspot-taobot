#!/bin/bash
# shellcheck disable=1090,1091,2207

set -e

project=$(dirname "${0}" | xargs basename)


if [[ "${project}" = "bin" ]]; then
  app_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../")
  cmd=$(basename "${0}")

  source "${app_dir}/bin/utils" # ascii_print

  ascii_print "Please run in the context of a project (e.g. ./bin/<project>/${cmd})" "red" >&2

  exit 1;
fi

app_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../../")
log_dir="${app_dir}/log/${project}/ml/five_min_predict"

source "${app_dir}/bin/utils" # ASCII, ascii_print

ascii_print "$(date)\n" "cyan"

mkdir -p "${log_dir}"

function build_candles_all() {
  ascii_print "ðŸ”¨ Building candles for all symbols" "cyan"

  symbols=($(cat "${app_dir}/bin/${project}/symbols"))

  for symbol in "${symbols[@]}"; do
    "${app_dir}/build/db" build_five_min_candles "${symbol}" "${@}" > "${log_dir}/${symbol}.log"
  done
}

function predict_all() {
  ascii_print "ðŸ¤– Updating predictions" "cyan"

  build_candles_all "${@}"

  symbols=($(cat "${app_dir}/bin/${project}/symbols"))

  for symbol in "${symbols[@]}"; do
    "${app_dir}/bin/ml/five_min_predict" predict "${symbol}" "${@}" >> "${log_dir}/${symbol}.log" 2>/dev/null
  done
}

function train_all() {
  ascii_print "ðŸ¤– Re-training models for all symbols" "cyan"

  build_candles_all "${@}"

  symbols=($(cat "${app_dir}/bin/${project}/symbols"))

  for symbol in "${symbols[@]}"; do
    "${app_dir}/bin/ml/five_min_predict" train "${symbol}" "${@}" >> "${log_dir}/${symbol}.log" 2>/dev/null
  done
}

case "${1}" in
  build_candles_all)
    build_candles_all "${@:2}"
    ;;
  predict_all)
    predict_all "${@:2}"
    ;;
  train_all)
    train_all "${@:2}"
    ;;
  *)
    ascii_print "ðŸ¤– ${ASCII["underline"]}FIVE MINUTE PREDICTIONS" "yellow"
    ascii_print "Commands: " "yellow"
    ascii_print "build_candles_all [--env]....Build candles for all symbols" "yellow"
    ascii_print "predict_all [--env]..........Update the predictions for all symbols" "yellow"
    ascii_print "train_all [--env]............Train models for all symbols" "yellow"
esac
